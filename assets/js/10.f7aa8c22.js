(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{382:function(t,s,a){t.exports=a.p+"assets/img/create-dom1.c8518580.jpg"},383:function(t,s,a){t.exports=a.p+"assets/img/create-dom2.a9e0987f.jpg"},384:function(t,s,a){t.exports=a.p+"assets/img/create-dom3.ce245412.jpg"},459:function(t,s,a){"use strict";a.r(s);var n=a(41),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"chrome浏览器-dom-树构建过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#chrome浏览器-dom-树构建过程"}},[t._v("#")]),t._v(" Chrome浏览器 DOM 树构建过程")]),t._v(" "),n("hr"),t._v(" "),n("p",[n("em",[t._v("2020/11/01")])]),t._v(" "),n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("近日看到"),n("strong",[t._v("会编程的银猪")]),t._v("大神写的 "),n("a",{attrs:{href:"https://www.rrfed.com/2017/01/30/chrome-build-dom/",target:"_blank",rel:"noopener noreferrer"}},[t._v("从Chrome源码看浏览器如何构建DOM树"),n("OutboundLink")],1),t._v("，感觉写的非常精彩，他把 Chrome 浏览器源码下载到本地，采用debug模式，来看DOM树生成过程，我这属于对这篇文章的一个总结。")])]),t._v(" "),n("h2",{attrs:{id:"dom-对象结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dom-对象结构"}},[t._v("#")]),t._v(" DOM 对象结构")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("Chrome源码是 "),n("strong",[t._v("C++")]),t._v(" 写的，先看看构建 DOM 对象的几个关键类的 UML 图：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(382),alt:"create-dom1"}})]),t._v(" "),n("p",[n("strong",[t._v("Node")]),t._v(" 对象是所有 DOM 元素的父类，它有几个属性，分别指向父节点和前后兄弟节点，后面几个子类各自扩展了一些属性。")])]),t._v(" "),n("h2",{attrs:{id:"构建-dom-树"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#构建-dom-树"}},[t._v("#")]),t._v(" 构建 DOM 树")]),t._v(" "),n("h3",{attrs:{id:"启动-documentloader"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动-documentloader"}},[t._v("#")]),t._v(" 启动 DocumentLoader")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("当在浏览器地址栏输入一个网址，浏览器用网络进程发起请求，服务器返回一串字符串，通过Chrome内核Blink封装的IPC进程间通信，触发DocumentLoader的dataReceived函数，里面会去调它的commitData函数，开始具体业务处理，为方便阅读，我们把字符串内容格式化下，如下：")]),t._v(" "),n("div",{staticClass:"language-html line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{pre:!0,attrs:{class:"token doctype"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<!")]),n("span",{pre:!0,attrs:{class:"token doctype-tag"}},[t._v("DOCTYPE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token name"}},[t._v("html")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("html")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("head")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("meta")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("charset")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("utf-8"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("head")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("body")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("h1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("title"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("demo"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("h1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("hello"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("body")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("html")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br")])]),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" DocumentLoader"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" bytes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ensureWriter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m_response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mimeType")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n \n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    m_dataReceived "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" true"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n \n  m_writer"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bytes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" DocumentLoader"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ensureWriter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" AtomicString"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" mimeType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" KURL"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" overridingURL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m_writer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 确保Parser和document只会初始化一次")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br")])]),n("p",[t._v("HTMLDocumentParser 类会负责将这些 html 文本解析为 "),n("strong",[t._v("tokens")]),t._v("，一个 token 就是一个标签文本的描述，并借助HTMLTreeBuilder 对这些tokens分类处理，根据不用的标签类型、在文档不同位置，调用HTMLConstructionSite不同的函数构建DOM树。在构建过程中建立起它们的父子兄弟关系，其中它有一个 m_document 成员变量，指向这棵树的根节点，即 window.document。")])]),t._v(" "),n("h3",{attrs:{id:"生成-tokens"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#生成-tokens"}},[t._v("#")]),t._v(" 生成 tokens")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("我们直接看下上面那串字符串生成对应的tokens的一些关键信息，其实也有点类似 "),n("strong",[t._v("AST")]),t._v("：")]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("tagName"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" html  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DOCTYPE")]),t._v("   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n"\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" html  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" startTag  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n"\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" head  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" startTag  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n    "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" meta  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" startTag  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("charset"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n"\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" head  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EndTag    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n"\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" body  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" startTag  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n    "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" div   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" startTag  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n        "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" h1    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" startTag  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("title   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' demo"\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" h1    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EndTag    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n        "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" input "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" startTag  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("value"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("hello   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n    "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" div   "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EndTag    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v('     \\n"\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" body  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EndTag    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n"\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" html  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EndTag    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Character "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' \\n"\ntagName'),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EndOfFile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("attr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(' "\n')])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br")])]),n("p",[t._v("可以看到 Parse 将服务端放回的html字符串信息解析得非常详细，包含标签名、类型、属性、innerText。Chrome总共定义了7种token标签类型：")]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("enum")]),t._v(" TokenType "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  Uninitialized"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DOCTYPE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  StartTag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  EndTag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  Comment"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  Character"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  EndOfFile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br")])])]),t._v(" "),n("h3",{attrs:{id:"处理-tokens-生成-dom-树"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#处理-tokens-生成-dom-树"}},[t._v("#")]),t._v(" 处理 tokens 生成 DOM 树")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("tokens 生成以后，在HTMLDocumentParser::processTokenizedChunkFromBackgroundParser函数里遍历tokens，依次调用constructTreeFromCompactHTMLToken进行处理，它会对不同类型的节点做相应处理，从上往下一次是文本节点、doctype节点、开标签、闭标签等。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" HTMLTreeBuilder"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processToken")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AtomicHTMLToken"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" HTMLToken"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("Character"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processCharacter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n \n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" HTMLToken"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("DOCTYPE"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processDoctypeToken")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" HTMLToken"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("StartTag"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processStartTag")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" HTMLToken"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("EndTag"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processEndTag")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//othercode")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br")])])]),t._v(" "),n("h4",{attrs:{id:"doctype-处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#doctype-处理"}},[t._v("#")]),t._v(" DOCType 处理")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("DOCTYPE 类型token会调用processDoctypeToken函数，里面调了HTMLConstructionSite的插入doctype的函数：")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" HTMLTreeBuilder"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processDoctypeToken")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AtomicHTMLToken"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  m_tree"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("insertDoctype")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInsertionMode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BeforeHTMLMode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("p",[t._v("在这个函数里面，它会先创建一个doctype的结点，再创建插dom的task，并设置文档类型：")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" HTMLConstructionSite"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("insertDoctype")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AtomicHTMLToken"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//const String& publicId = ...")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//const String& systemId = ...")]),t._v("\n  DocumentType"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" doctype "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n      DocumentType"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m_document"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" token"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" publicId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" systemId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//创建DOCType结点")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("attachLater")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m_attachmentRoot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" doctype"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//创建插DOM的task")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompatibilityModeFromDoctype")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" publicId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" systemId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//设置文档类型")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("p",[t._v("设置不同的doctype对文档类型设置有不同的影响，")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Check for Quirks Mode.")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"html"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompatibilityMode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Document"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("QuirksMode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])]),n("p",[t._v("如果 tagName 不是html，那么文档类型将会是怪异模式或有限怪异模式：")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 怪异模式")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("DOCType svg"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("DOCType math"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 有限怪异模式")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("DOCTYPE HTML PUBLIC "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-//W3C//DTD HTML 4.01 Transitional//EN"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://www.w3.org/TR/html4/loose.dtd"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Check for Limited Quirks Mode.")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("systemId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEmpty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n      publicId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("startsWith")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-//W3C//DTD HTML 4.01 Transitional//"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                          TextCaseASCIIInsensitive"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCompatibilityMode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Document"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("LimitedQuirksMode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br")])]),n("p",[t._v("常用的html5的写法是标准模式，如果连DOCType声明也没有，那么会默认设置为怪异模式。各模式的区别源码注释如下：")])]),t._v(" "),n("div",{staticClass:"custom-block warning"},[n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// There are three possible compatibility modes:")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Quirks - quirks mode emulates WinIE and NS4. CSS parsing is also relaxed in")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this mode, e.g., unit types can be omitted from numbers.")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Limited Quirks - This mode is identical to no-quirks mode except for its")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// treatment of line-height in the inline box model.")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// No Quirks - no quirks apply. Web pages will obey the specifications to the")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// letter.")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("p",[t._v("大意是说，怪异模式会模拟IE，同时CSS解析会比较宽松，例如数字单位可以省略，而有限怪异模式和标准模式的唯一区别在于在于对inline元素的行高处理不一样。标准模式将会让页面遵守文档规定。")])]),t._v(" "),n("h4",{attrs:{id:"开标签处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开标签处理"}},[t._v("#")]),t._v(" 开标签处理")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("下一个遇到的开标签是 <html> 标签，处理这个标签的任务是实例化一个 HTMLHtmlElement 元素，然后把它的父元素指向document，同时，会把这个元素压到一个栈里面，这个栈存放了未遇到闭标签的所有开标签。")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" HTMLConstructionSite"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("insertHTMLHtmlStartTagBeforeHTML")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AtomicHTMLToken"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  HTMLHtmlElement"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" element "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" HTMLHtmlElement"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("m_document"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实例化 HTMLHtmlElement")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("attachLater")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m_attachmentRoot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" element"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 把element元素放到任务队列")]),t._v("\n  m_openElements"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("pushHTMLHtmlElement")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("HTMLStackItem"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 开标签入栈")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("executeQueuedTasks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行队列中的任务")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])]),n("p",[t._v("在 executeQueuedTasks 函数中，会根据task的类型执行不同的操作，当执行插入操作时，会设置好其父节点指向（即栈顶的开标签）。")])]),t._v(" "),n("h4",{attrs:{id:"闭标签处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#闭标签处理"}},[t._v("#")]),t._v(" 闭标签处理")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("当遇到一个闭标签时，会把栈元素的元素一直pop出来，直到第一个和它标签名字一样的：")]),t._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("m_tree"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("openElements")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("popUntilPopped")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("我们第一个遇到的是闭标签是head标签，它会把开的head标签pop出来，栈里面就剩下html元素了，所以当再遇到body时，html元素就是body的父元素了。")]),t._v(" "),n("p",[n("strong",[t._v("注意：")]),t._v(" 遇到body闭标签后，并不会把body给pop出来，因为如果body闭标签后面又再写了标签的话，就会自动当成body的子元素。")]),t._v(" "),n("p",[t._v("Chrome内核Blink标签处理的容错能力比较强的，对于特殊标签，它另外维护了一个列表，当某些标签忘记写闭标签时，都有相应处理。")])]),t._v(" "),n("h4",{attrs:{id:"自定义标签处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自定义标签处理"}},[t._v("#")]),t._v(" 自定义标签处理")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("在浏览器里面可以看到，自定义标签默认不会有任何的样式，并且默认是一个行内元素，初步观察它和span标签的表现是一样的：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(383),alt:"create-dom2"}})]),t._v(" "),n("p",[n("img",{attrs:{src:a(384),alt:"create-dom3"}})]),t._v(" "),n("p",[t._v("在 Blink 源码中，不认识的标签默认会被实例化成一个 "),n("strong",[t._v("HTMLUnknownElement")]),t._v("，这个类对外提供了一个create函数，这和 "),n("strong",[t._v("HTMLSpanElement")]),t._v(" 是一样的，只有一个 create 函数，并且大家都是继承 HTMLElement。并且创建span标签的时候和unknown一样，并没有做特殊处理，直接调的create。所以从本质上来说，可以把自定义的标签当作一个span看待。然后你可以再设置display: block改成块级元素之类的。")]),t._v(" "),n("p",[t._v("但是我们可以用 js 自定义一个标签，定义它的属性，Blink 会去读它的定义，这个标签继承于 HTMLElement(或其他Element)，并且调用接口注册。"),n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_custom_elements",target:"_blank",rel:"noopener noreferrer"}},[t._v("custom elements"),n("OutboundLink")],1)])]),t._v(" "),n("h2",{attrs:{id:"后续"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#后续"}},[t._v("#")]),t._v(" 后续")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("其实在构建 DOM 树的时候也在构建 CSS的渲染树，两棵树都构建好之后构建布局树，最后绘制呈现。")]),t._v(" "),n("p",[t._v("更详细的推荐到原文查看 "),n("a",{attrs:{href:"https://www.rrfed.com/2017/01/30/chrome-build-dom/",target:"_blank",rel:"noopener noreferrer"}},[t._v("原文"),n("OutboundLink")],1)]),t._v(" "),n("p",[n("a",{attrs:{href:"/frontend"}},[t._v("回首页")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);