<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CommonJS 和 ESM 中的循环依赖 | 张宁-个人博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="前端、C#、算法、生活......">
    
    <link rel="preload" href="/assets/css/0.styles.65a9d785.css" as="style"><link rel="preload" href="/assets/js/app.73819cc8.js" as="script"><link rel="preload" href="/assets/js/2.1d157987.js" as="script"><link rel="preload" href="/assets/js/18.64ee49bc.js" as="script"><link rel="prefetch" href="/assets/js/10.f7aa8c22.js"><link rel="prefetch" href="/assets/js/11.68be72b2.js"><link rel="prefetch" href="/assets/js/12.2f13c77f.js"><link rel="prefetch" href="/assets/js/13.60fe103f.js"><link rel="prefetch" href="/assets/js/14.c9ded3f6.js"><link rel="prefetch" href="/assets/js/15.c3556b29.js"><link rel="prefetch" href="/assets/js/16.8c54a7e1.js"><link rel="prefetch" href="/assets/js/17.0b820cc5.js"><link rel="prefetch" href="/assets/js/19.f28019a2.js"><link rel="prefetch" href="/assets/js/20.d3231e89.js"><link rel="prefetch" href="/assets/js/21.4cef60ce.js"><link rel="prefetch" href="/assets/js/22.670c4a5a.js"><link rel="prefetch" href="/assets/js/23.ab4be979.js"><link rel="prefetch" href="/assets/js/24.59a6b942.js"><link rel="prefetch" href="/assets/js/25.483117e0.js"><link rel="prefetch" href="/assets/js/26.671a06b1.js"><link rel="prefetch" href="/assets/js/27.c3fc8241.js"><link rel="prefetch" href="/assets/js/28.4a9d0045.js"><link rel="prefetch" href="/assets/js/29.59e1c35b.js"><link rel="prefetch" href="/assets/js/3.4103b7e1.js"><link rel="prefetch" href="/assets/js/30.07b4c4e3.js"><link rel="prefetch" href="/assets/js/31.80ddf6b7.js"><link rel="prefetch" href="/assets/js/32.5ac36d6f.js"><link rel="prefetch" href="/assets/js/33.f906ce7a.js"><link rel="prefetch" href="/assets/js/34.ebd39fbe.js"><link rel="prefetch" href="/assets/js/35.cfdae827.js"><link rel="prefetch" href="/assets/js/36.1655e37e.js"><link rel="prefetch" href="/assets/js/37.625c187d.js"><link rel="prefetch" href="/assets/js/38.a7b0b0ff.js"><link rel="prefetch" href="/assets/js/39.40e33dba.js"><link rel="prefetch" href="/assets/js/4.c98340cf.js"><link rel="prefetch" href="/assets/js/40.5fc10627.js"><link rel="prefetch" href="/assets/js/41.fe32f84d.js"><link rel="prefetch" href="/assets/js/42.87fa8e79.js"><link rel="prefetch" href="/assets/js/43.55e09ac6.js"><link rel="prefetch" href="/assets/js/44.70e7a5c0.js"><link rel="prefetch" href="/assets/js/45.3259b240.js"><link rel="prefetch" href="/assets/js/46.1e92f698.js"><link rel="prefetch" href="/assets/js/47.329bf0e4.js"><link rel="prefetch" href="/assets/js/5.ab149363.js"><link rel="prefetch" href="/assets/js/6.dfa8bf1a.js"><link rel="prefetch" href="/assets/js/7.97018498.js"><link rel="prefetch" href="/assets/js/8.6a48e8a0.js"><link rel="prefetch" href="/assets/js/9.9443a568.js">
    <link rel="stylesheet" href="/assets/css/0.styles.65a9d785.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">张宁-个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/frontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link">
  .NET
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="https://github.com/nandehutuzn/zn-blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/frontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link">
  .NET
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="https://github.com/nandehutuzn/zn-blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>CommonJS 和 ESM 中的循环依赖</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/circular-ref.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frontend/circular-ref.html#commonjs" class="sidebar-link">CommonJS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/circular-ref.html#示例" class="sidebar-link">示例</a></li><li class="sidebar-sub-header"><a href="/frontend/circular-ref.html#结果分析" class="sidebar-link">结果分析</a></li></ul></li><li><a href="/frontend/circular-ref.html#es-module" class="sidebar-link">ES Module</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/circular-ref.html#示例-2" class="sidebar-link">示例</a></li><li class="sidebar-sub-header"><a href="/frontend/circular-ref.html#结果分析-2" class="sidebar-link">结果分析</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="commonjs-和-esm-中的循环依赖"><a href="#commonjs-和-esm-中的循环依赖" class="header-anchor">#</a> CommonJS 和 ESM 中的循环依赖</h1> <hr> <p><em>2020/12/18</em></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <div class="custom-block tip"><p>近些年前端也模块化了，实现模块化就涉及依赖外部模块，由此必然会引入循环依赖的问题，a 依赖 b、b 依赖 a，今天就看看 <code>CommonJS</code> 和 <code>ES Module</code> 各自是怎么处理循环依赖的。</p></div> <h2 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> CommonJS</h2> <div class="custom-block tip"><p>首先需要理解 <code>CommonJS</code> 的模块加载机制，可参考 <a href="/frontend/cjs.html">Node 模块加载机制</a>，简单的说就是系统会把文件内容包裹在一个函数内，并给这个函数提供 <strong>module</strong>、<strong>exports</strong> 等一些入参，也就是说它的加载过程是同步的。下面看一个例子：</p></div> <h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <div class="custom-block tip"><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// a.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'enter a.js'</span><span class="token punctuation">)</span>
exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start load b.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moduleb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./b.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loaded b.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moduleb<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">8</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'leave a.js'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// b.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'enter b.js'</span><span class="token punctuation">)</span>
exports<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start load a.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> modulea <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loaded a.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>modulea<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
exports<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">10</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'leave b.js'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 命令行执行  node main.js</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>输出结果如下：</p> <p><img src="/assets/img/circle-ref1.adf248c3.jpg" alt="commonjs"></p></div> <h3 id="结果分析"><a href="#结果分析" class="header-anchor">#</a> 结果分析</h3> <div class="custom-block tip"><p>根据代码执行顺序再走一遍就能清楚 <code>CommonJS</code> 是怎么处理循环引用的了，首先 main.js 文件加载 a.js，进入 a.js 文件，输出 <code>enter a.js</code>，此时 <code>模块a.js</code> 导出的 <strong>a</strong> 属性值为2，然后去加载 b.js，进入 b.js 文件，输出 <code>enter b.js</code>，此时 <code>模块b.js</code> 导出的 <strong>b</strong> 属性值为1，然后又去加载 a.js，因为 a.js 模块已经被 main.js 加载过一次了，即全局缓存内已经存在一个 <code>模块a.js</code> 文件对应的一个对象，只不过这个对象的 <code>loaded</code> 属性为 <code>false</code>，即还未完全加载完毕，但是 <code>模块a.js</code> 导出的 <strong>a</strong> 属性已经挂载到该对象上了，只不过a属性的值仍然为2。所以 <code>模块b.js</code> 中获取到的 <code>modulea.a</code> 的值为 2，然后将 <code>模块b.js</code> 导出的 <strong>b</strong> 属性值修改为 10，随后 b.js 文件加载完毕，即该模块生成对象的 <code>loaded</code> 属性设置为 <code>true</code>。然后回到 a.js 继续执行输出 <code>loaded b.js</code>，此时 <code>moduleb.b</code> 的值为10，随后 <code>模块a.js</code> 导出的 <strong>a</strong> 属性值修改为 8，<code>模块a.js</code> 加载完毕，模块对应对象的 <code>loaded</code> 属性值变成 <code>true</code>。a.js、b.js文件模块都加载完毕。</p> <p>可以发现 <code>CommonJS</code> 的循环依赖解析走的是深度优先。</p></div> <h2 id="es-module"><a href="#es-module" class="header-anchor">#</a> ES Module</h2> <div class="custom-block tip"><p><code>ES Module</code> 引入和 <code>CommonJS</code> 的引入是不一样的，<code>ES Module</code> 导出的是一个引用地址，即该模块被导入后，它们指向的是同一份内存地址，也是看一个例子：</p></div> <h3 id="示例-2"><a href="#示例-2" class="header-anchor">#</a> 示例</h3> <div class="custom-block tip"><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// a.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'enter a.js'</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> b <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./b.js'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">a.js module.b </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// b.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'enter b.js'</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">b.js module.a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">esm a: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>输出结果如下：</p> <p><img src="data:image/jpeg;base64,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" alt="esm"></p></div> <h3 id="结果分析-2"><a href="#结果分析-2" class="header-anchor">#</a> 结果分析</h3> <div class="custom-block tip"><p>首先js引擎如果检查到文件内有 import/export 关键字，则会认为你使用的是 <code>ES Module</code>，然后将 <code>import</code> 关键字提升到文件最前面，这就导致了 <code>enter a.js</code> 不是最先输出的。<code>模块 b.js</code> 去加载 <code>模块 a.js</code>时，发现它还没有被标记为解析完毕，所以此时 <code>模块 a.js</code> 导出的 <strong>a</strong> 是 <code>undefined</code> 。解析完 <code>模块 b.js</code> 之后再继续解析 <code>模块 a.js</code>，所以在 a.js 文件中能顺利的获取到 b.js文件导出的 b。</p> <p>从这里可以看出 <code>ES Module</code> 依赖也是遵循深度优先去解析依赖，但是它会比 <code>CommonJS</code> 简单一些，首先将所有 <code>import</code> 关键字的外部依赖移动到文件头部，先去加载外部依赖，此时该模块标记为 <code>fetching</code>，如果外部模块又依赖该模块时，在同步情况下是获取不到的，但是在异步情况下是可以获取到，即在 a.js 文件解析完毕之后，依赖的值会更新。如下修改 b.js：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'enter b.js'</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">b.js module.a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">setTimeout b.js module.a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><a href="/frontend">回首页</a></p></div> <p>（完）</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.73819cc8.js" defer></script><script src="/assets/js/2.1d157987.js" defer></script><script src="/assets/js/18.64ee49bc.js" defer></script>
  </body>
</html>
