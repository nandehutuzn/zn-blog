<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>@vue/cli-service 插件原理 | 张宁-个人博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="前端、C#、算法、生活......">
    
    <link rel="preload" href="/assets/css/0.styles.65a9d785.css" as="style"><link rel="preload" href="/assets/js/app.73819cc8.js" as="script"><link rel="preload" href="/assets/js/2.1d157987.js" as="script"><link rel="preload" href="/assets/js/34.ebd39fbe.js" as="script"><link rel="prefetch" href="/assets/js/10.f7aa8c22.js"><link rel="prefetch" href="/assets/js/11.68be72b2.js"><link rel="prefetch" href="/assets/js/12.2f13c77f.js"><link rel="prefetch" href="/assets/js/13.60fe103f.js"><link rel="prefetch" href="/assets/js/14.c9ded3f6.js"><link rel="prefetch" href="/assets/js/15.c3556b29.js"><link rel="prefetch" href="/assets/js/16.8c54a7e1.js"><link rel="prefetch" href="/assets/js/17.0b820cc5.js"><link rel="prefetch" href="/assets/js/18.64ee49bc.js"><link rel="prefetch" href="/assets/js/19.f28019a2.js"><link rel="prefetch" href="/assets/js/20.d3231e89.js"><link rel="prefetch" href="/assets/js/21.4cef60ce.js"><link rel="prefetch" href="/assets/js/22.670c4a5a.js"><link rel="prefetch" href="/assets/js/23.ab4be979.js"><link rel="prefetch" href="/assets/js/24.59a6b942.js"><link rel="prefetch" href="/assets/js/25.483117e0.js"><link rel="prefetch" href="/assets/js/26.671a06b1.js"><link rel="prefetch" href="/assets/js/27.c3fc8241.js"><link rel="prefetch" href="/assets/js/28.4a9d0045.js"><link rel="prefetch" href="/assets/js/29.59e1c35b.js"><link rel="prefetch" href="/assets/js/3.4103b7e1.js"><link rel="prefetch" href="/assets/js/30.07b4c4e3.js"><link rel="prefetch" href="/assets/js/31.80ddf6b7.js"><link rel="prefetch" href="/assets/js/32.5ac36d6f.js"><link rel="prefetch" href="/assets/js/33.f906ce7a.js"><link rel="prefetch" href="/assets/js/35.cfdae827.js"><link rel="prefetch" href="/assets/js/36.1655e37e.js"><link rel="prefetch" href="/assets/js/37.625c187d.js"><link rel="prefetch" href="/assets/js/38.a7b0b0ff.js"><link rel="prefetch" href="/assets/js/39.40e33dba.js"><link rel="prefetch" href="/assets/js/4.c98340cf.js"><link rel="prefetch" href="/assets/js/40.5fc10627.js"><link rel="prefetch" href="/assets/js/41.fe32f84d.js"><link rel="prefetch" href="/assets/js/42.87fa8e79.js"><link rel="prefetch" href="/assets/js/43.55e09ac6.js"><link rel="prefetch" href="/assets/js/44.70e7a5c0.js"><link rel="prefetch" href="/assets/js/45.3259b240.js"><link rel="prefetch" href="/assets/js/46.1e92f698.js"><link rel="prefetch" href="/assets/js/47.329bf0e4.js"><link rel="prefetch" href="/assets/js/5.ab149363.js"><link rel="prefetch" href="/assets/js/6.dfa8bf1a.js"><link rel="prefetch" href="/assets/js/7.97018498.js"><link rel="prefetch" href="/assets/js/8.6a48e8a0.js"><link rel="prefetch" href="/assets/js/9.9443a568.js">
    <link rel="stylesheet" href="/assets/css/0.styles.65a9d785.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">张宁-个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/frontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link">
  .NET
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="https://github.com/nandehutuzn/zn-blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/frontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/dotnet/" class="nav-link">
  .NET
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="https://github.com/nandehutuzn/zn-blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>@vue/cli-service 插件原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/cli-service.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frontend/cli-service.html#常用的两个插件api" class="sidebar-link">常用的两个插件API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/cli-service.html#configuredevserver" class="sidebar-link">configureDevServer</a></li><li class="sidebar-sub-header"><a href="/frontend/cli-service.html#registercommand" class="sidebar-link">registerCommand</a></li><li class="sidebar-sub-header"><a href="/frontend/cli-service.html#插件注册" class="sidebar-link">插件注册</a></li></ul></li><li><a href="/frontend/cli-service.html#读源码" class="sidebar-link">读源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/cli-service.html#bin-vue-cli-service-js" class="sidebar-link">bin/vue-cli-service.js</a></li><li class="sidebar-sub-header"><a href="/frontend/cli-service.html#lib-service-js" class="sidebar-link">lib/Service.js</a></li><li class="sidebar-sub-header"><a href="/frontend/cli-service.html#lib-pluginapi-js" class="sidebar-link">lib/PluginAPI.js</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-cli-service-插件原理"><a href="#vue-cli-service-插件原理" class="header-anchor">#</a> @vue/cli-service 插件原理</h1> <hr> <p><em>2020/11/08</em></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <div class="custom-block tip"><p>Vue-CLi 3 之前，vue-cli 只是一个功能很单一的脚手架工具，它唯一的功能就是基于模板创建一个 Vue 项目，项目创建完，它的任务也完成了。</p> <p>而 Vue-Cli 3 以后，它的功能变得更加丰富了，可以说项目创建、开发、测试、构建、部署等它都可以有用武之地，它不仅帮我们最大化内置了一些常用功能（开箱即用），还提供了插件机制给开发者扩展的机会，下面就看看和开发者息息相关的 @vue/cli-service 实现原理，及我们能怎么更好的利用它给开发提速。</p></div> <h2 id="常用的两个插件api"><a href="#常用的两个插件api" class="header-anchor">#</a> 常用的两个插件API</h2> <h3 id="configuredevserver"><a href="#configuredevserver" class="header-anchor">#</a> configureDevServer</h3> <div class="custom-block tip"><p>可以通过这个方法在开发服务器上实现一些自己的操作，比如打印每次的请求信息，拦截每次请求，并返回自己的mock数据等，它传入一个app参数，即本地开启的express服务。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mock-server.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">configureDevServer</span><span class="token punctuation">(</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div> <h3 id="registercommand"><a href="#registercommand" class="header-anchor">#</a> registerCommand</h3> <div class="custom-block tip"><p>通过这个方法可以注册一个自己的命令(myCommand)，当在命令行运行 vue-cli-service myCommand 时，通过node做些自己想做的事情，如删除一些文件，新建一些文件，合并一些文件等。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  api<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span><span class="token string">'myCommand'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> rawArgs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 node 做更多的事，如文件读写</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <h3 id="插件注册"><a href="#插件注册" class="header-anchor">#</a> 插件注册</h3> <div class="custom-block tip"><p>在项目 package.json 文件中通过 vuePlugin 字段对它们进行注册</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// package.json</span>
<span class="token string">&quot;vuePlugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;service&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;第一个插件文件地址&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;第二个插件文件地址&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>下面源码简单看看他们的实现</p></div> <h2 id="读源码"><a href="#读源码" class="header-anchor">#</a> 读源码</h2> <div class="custom-block tip"><p>随便找个 vue 项目，找到 node_modules/@vue/cli-service/package.json 起点文件，因为我们一般是以命令行的方式（vue-cli-service serve）使用它，所以找到 package.json 文件的 bin 字段：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// node_modules/@vue/cli-service/package.json</span>
<span class="token string">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;vue-cli-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bin/vue-cli-service.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <h3 id="bin-vue-cli-service-js"><a href="#bin-vue-cli-service-js" class="header-anchor">#</a> bin/vue-cli-service.js</h3> <div class="custom-block tip"><p>即，当我们在命令行输入 npm run serve，Node 就找到 node_modules/@vue/cli-service/bin/vue-cli-service.js 文件，开始执行。在这个文件里，它除了做了一些校验外，还做了两件事，一是提取命令行中的参数值，还有一个就是创建了一个 <strong>Service</strong> 对象，并在最后调用 Service 实例的 run() 方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//... 校验等省略</span>
<span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/Service'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_CONTEXT</span> <span class="token operator">||</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> rawArgv <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'minimist'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>rawArgv<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  boolean<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// build</span>
    <span class="token string">'modern'</span><span class="token punctuation">,</span>
    <span class="token string">'report'</span><span class="token punctuation">,</span>
    <span class="token string">'report-json'</span><span class="token punctuation">,</span>
    <span class="token string">'inline-vue'</span><span class="token punctuation">,</span>
    <span class="token string">'watch'</span><span class="token punctuation">,</span>
    <span class="token comment">// serve</span>
    <span class="token string">'open'</span><span class="token punctuation">,</span>
    <span class="token string">'copy'</span><span class="token punctuation">,</span>
    <span class="token string">'https'</span><span class="token punctuation">,</span>
    <span class="token comment">// inspect</span>
    <span class="token string">'verbose'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 跟在 vue-cli-service 后的命令，如内置的 serve、build等</span>
<span class="token keyword">const</span> command <span class="token operator">=</span> args<span class="token punctuation">.</span>_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

service<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> args<span class="token punctuation">,</span> rawArgv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></div> <h3 id="lib-service-js"><a href="#lib-service-js" class="header-anchor">#</a> lib/Service.js</h3> <div class="custom-block tip"><p>先看下它的构造函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> <span class="token punctuation">{</span> plugins<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> inlineOptions<span class="token punctuation">,</span> useBuiltIn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token constant">VUE_CLI_SERVICE</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>initialized <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context
    <span class="token keyword">this</span><span class="token punctuation">.</span>inlineOptions <span class="token operator">=</span> inlineOptions
    <span class="token keyword">this</span><span class="token punctuation">.</span>webpackChainFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>webpackRawConfigFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>devServerConfigFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>commands <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// Folder containing the target package.json for plugins</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pkgContext <span class="token operator">=</span> context
    <span class="token comment">// package.json containing the plugins</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pkg <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePkg</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span>
    <span class="token comment">// 从项目 package.json 文件的 vuePlugin 字段加载插件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePlugins</span><span class="token punctuation">(</span>plugins<span class="token punctuation">,</span> useBuiltIn<span class="token punctuation">)</span>
    <span class="token comment">// pluginsToSkip will be populated during run()</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pluginsToSkip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// this.modes = { serve: 'development', build: 'production', inspect: 'development' }</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">modes<span class="token punctuation">,</span> <span class="token punctuation">{</span> apply<span class="token operator">:</span> <span class="token punctuation">{</span> defaultModes <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>modes<span class="token punctuation">,</span> defaultModes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token function">resolvePlugins</span> <span class="token punctuation">(</span><span class="token parameter">inlinePlugins<span class="token punctuation">,</span> useBuiltIn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... </span>
  <span class="token comment">// 加载本地插件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>vuePlugins <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>vuePlugins<span class="token punctuation">.</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>vuePlugins<span class="token punctuation">.</span>service
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid type for option 'vuePlugins.service', expected 'array' but got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> files<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    plugins <span class="token operator">=</span> plugins<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">local:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      apply<span class="token operator">:</span> <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkgContext<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> plugins
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>删除了一些注释，这里我们需要关注的两个属性 <strong>this.commands</strong>、<strong>this.plugins</strong>，如果我们后面要给 cli-service 增加插件，都会保存到这两个属性里面。也就是说 new Service() 之后，this.plugins[] 已经包含了内置插件和本地插件，但是 this.commands 属性还是空的，继续往下看 run() 方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">async</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rawArgv <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// name 就是 command，即 serve、build ...</span>
    <span class="token comment">// resolve mode</span>
    <span class="token comment">// prioritize inline --mode</span>
    <span class="token comment">// fallback to resolved default modes from plugins or development if --watch is defined</span>
    <span class="token keyword">const</span> mode <span class="token operator">=</span> args<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'build'</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>watch <span class="token operator">?</span> <span class="token string">'development'</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modes<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// --skip-plugins arg may have plugins that should be skipped during init()</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setPluginsToSkip</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>

    <span class="token comment">// load env variables, load user config, apply plugins</span>
    <span class="token comment">// 这个方法里对 this.commands、this.plugins 做了些处理</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span>

    args<span class="token punctuation">.</span>_ <span class="token operator">=</span> args<span class="token punctuation">.</span>_ <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">command &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; does not exist.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command <span class="token operator">||</span> args<span class="token punctuation">.</span>help <span class="token operator">||</span> args<span class="token punctuation">.</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">.</span>help
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      args<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// remove command itself</span>
      rawArgv<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> fn <span class="token punctuation">}</span> <span class="token operator">=</span> command
    <span class="token comment">// 从 command 中取出定义好的方法，执行它</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> rawArgv<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>这个方法里面的逻辑也不复杂，根据 name 从 this.commands 中取出方法去执行，而 this.commands 数据是在 this.init() 方法里进行的，看看 this.init() 方法.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">mode <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_MODE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// apply plugins.</span>
    <span class="token comment">// 遍历 this.plugins，</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> id<span class="token punctuation">,</span> apply <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pluginsToSkip<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token comment">// 执行 this.plugins 每个元素的 apply方法</span>
      <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PluginAPI</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// apply webpack configs from project config file</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>chainWebpack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>webpackChainFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>chainWebpack<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>configureWebpack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>webpackRawConfigFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>configureWebpack<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>我们关注的 this.plugins，这里对它进行了一次遍历，并执行它的 apply 方法，apply 方法有两个参数，第一个是 <strong>PluginAPI</strong> 实例，第二个参数是 webpack 配置，通过 PluginAPI 构造函数第二个参数把自己(Service) 传递进行，看看 PluginAPI 做了啥。</p></div> <h3 id="lib-pluginapi-js"><a href="#lib-pluginapi-js" class="header-anchor">#</a> lib/PluginAPI.js</h3> <div class="custom-block tip"><p>这个对象的构造函数很简单，只是把当前的 service 对象缓存起来了，即 service 对象中的 commands 和 plugins 这两个一直在注视的属性也能拿到。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> service</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id
    <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>看到这里 cli-service 的原理差不多也清楚了， PluginAPI 实例就是我们创建 vuePlugin 本地插件导出方法的第一个参数，它暴露的方法在这里都能找到，比如下文会用到的 <strong>configureDevServer</strong>、 <strong>registerCommand</strong> 等。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token function">registerCommand</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> opts <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">=</span> opts
    opts <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 往 service.commands 对象注入自己的命令</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>commands<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> fn<span class="token punctuation">,</span> opts<span class="token operator">:</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">configureDevServer</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>devServerConfigFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">chainWebpack</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>webpackChainFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以发现在插件中实现的回调，背后都被添加开局阶段新建的 service 实例上，这样我们写的插件就能都被 vue-cli-service 用起来了。</p></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.73819cc8.js" defer></script><script src="/assets/js/2.1d157987.js" defer></script><script src="/assets/js/34.ebd39fbe.js" defer></script>
  </body>
</html>
